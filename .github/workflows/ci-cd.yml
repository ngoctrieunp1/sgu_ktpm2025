# name: CI/CD 3-tier

# on: [push]

# jobs:
#   # test_backend:
#   #   runs-on: ubuntu-latest
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     # ... c√°c b∆∞·ªõc test backend

#   test_backend:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-node@v4
#         with: { node-version: '20' }   # CI ch·∫°y Node 20 ok
#       - run: npm ci
#         working-directory: Server
#       - run: npm test
#         working-directory: Server

#   test_frontend:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       # ... c√°c b∆∞·ªõc test frontend

#   deploy:
#     needs: [test_backend, test_frontend]
#     runs-on: self-hosted

#     # üëá Quan tr·ªçng: d√πng Windows PowerShell 5 thay v√¨ pwsh
#     defaults:
#       run:
#         shell: powershell

#     steps:
#       - uses: actions/checkout@v4

#       - name: Ki·ªÉm tra Docker/Compose
#         run: |
#           docker --version
#           docker compose version

#       - name: Validate docker-compose.yml
#         run: docker compose config -q

#       - name: Deploy b·∫±ng Docker Compose
#         run: docker compose -f docker-compose.yml up -d --build

#       - name: D·ªçn ·∫£nh c≈© (optional)
#         run: docker image prune -f


name: CI/CD 3-tier

on:
  push:
    branches: [ main ]   # ch·ªâ ch·∫°y khi push l√™n nh√°nh main

jobs:
  test_backend:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'   # n·∫øu c·∫ßn, ƒë·ªïi th√†nh '18'

      - name: Show Node/NPM version
        run: |
          node -v
          npm -v
        working-directory: Server

      - name: Install dependencies
        run: npm ci --no-audit --no-fund || npm install --no-audit --no-fund
        working-directory: Server

      - name: Run Unit Tests
        env:
          NODE_ENV: test
        run: npm test
        working-directory: Server

  deploy:
    name: Deploy (self-hosted Windows)
    needs: [test_backend]
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        shell: powershell

    steps:
      - uses: actions/checkout@v4

      - name: Ki·ªÉm tra Docker/Compose
        run: |
          docker --version
          docker compose version

      - name: Validate docker-compose.yml
        run: docker compose config -q

      - name: Deploy b·∫±ng Docker Compose
        run: docker compose -f docker-compose.yml up -d --build

      - name: D·ªçn ·∫£nh c≈© (optional)
        run: docker image prune -f
