# name: CI/CD 3-tier

# on: [push]

# jobs:
#   # test_backend:
#   #   runs-on: ubuntu-latest
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     # ... c√°c b∆∞·ªõc test backend

#   test_backend:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-node@v4
#         with: { node-version: '20' }   # CI ch·∫°y Node 20 ok
#       - run: npm ci
#         working-directory: Server
#       - run: npm test
#         working-directory: Server

#   test_frontend:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       # ... c√°c b∆∞·ªõc test frontend

#   deploy:
#     needs: [test_backend, test_frontend]
#     runs-on: self-hosted

#     # üëá Quan tr·ªçng: d√πng Windows PowerShell 5 thay v√¨ pwsh
#     defaults:
#       run:
#         shell: powershell

#     steps:
#       - uses: actions/checkout@v4

#       - name: Ki·ªÉm tra Docker/Compose
#         run: |
#           docker --version
#           docker compose version

#       - name: Validate docker-compose.yml
#         run: docker compose config -q

#       - name: Deploy b·∫±ng Docker Compose
#         run: docker compose -f docker-compose.yml up -d --build

#       - name: D·ªçn ·∫£nh c≈© (optional)
#         run: docker image prune -f




# name: CI/CD 3-tier // b·∫£n c≈© ch·ªâ ch·∫°y test tr√™n main

# on:
#   push:
#     branches: [ main ]

# jobs:
#   test_backend:
#     name: Backend Unit & Integration Tests
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-node@v4
#         with:
#           node-version: '18'

#       - name: Show Node/NPM version
#         working-directory: Server
#         run: |
#           node -v
#           npm -v

#       - name: Install dependencies
#         working-directory: Server
#         run: |
#           npm ci --no-audit --no-fund || npm install --no-audit --no-fund

#       - name: Run Unit Tests
#         working-directory: Server
#         env:
#           NODE_ENV: test
#           CI: true
#         run: npm test

#       - name: Run Integration Tests (in-memory MongoDB)
#         working-directory: Server
#         env:
#           NODE_ENV: test
#           CI: true
#         run: npm run test:integration



# name: CI/CD 3-tier

# on:
#   # B·∫•t k·ª≥ push l√™n branch n√†o c≈©ng ch·∫°y test
#   push:

#   # Khi t·∫°o Pull Request v√†o main c≈©ng ch·∫°y test l·∫°i
#   pull_request:
#     branches:
#       - main

# jobs:
#   test_backend:
#     name: Backend Unit & Integration Tests
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-node@v4
#         with:
#           node-version: '18'

#       - name: Show Node/NPM version
#         working-directory: Server
#         run: |
#           node -v
#           npm -v

#       - name: Install dependencies
#         working-directory: Server
#         run: |
#           npm ci --no-audit --no-fund || npm install --no-audit --no-fund

#       - name: Run Unit Tests
#         working-directory: Server
#         env:
#           NODE_ENV: test
#           CI: true
#         run: npm test

#       - name: Run Integration Tests (in-memory MongoDB)
#         working-directory: Server
#         env:
#           NODE_ENV: test
#           CI: true
#         run: npm run test:integration





name: CI/CD 3-tier

on:
  push:
  pull_request:
    branches:
      - main
      - brandtest   # üëà Cho ph√©p PR v√†o main & brandtest ƒë·ªÅu ch·∫°y test

jobs:
  test_backend:
    name: Backend Unit & Integration Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      # üîπ Datadog CI Visibility (NEW)
      - name: Set up Datadog CI Visibility
        uses: DataDog/ci-visibility-github-actions@v3
        with:
          api-key: ${{ secrets.DD_API_KEY }}
          site: datadoghq.com

      - name: Show Node/NPM version
        working-directory: Server
        run: |
          node -v
          npm -v

      - name: Install dependencies
        working-directory: Server
        run: |
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund

      - name: Run Unit Tests
        working-directory: Server
        env:
          NODE_ENV: test
          CI: true
          DD_ENV: ci
          DD_SERVICE: backend-tests
          DD_SITE: datadoghq.com
        run: npm test

      - name: Run Integration Tests (in-memory MongoDB)
        working-directory: Server
        env:
          NODE_ENV: test
          CI: true
          DD_ENV: ci
          DD_SERVICE: backend-tests
          DD_SITE: datadoghq.com
        run: npm run test:integration
