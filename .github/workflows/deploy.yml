# name: CI/CD for SGU_KTPM2025

# on:
#   push:
#     branches: [ main ]   # Má»—i khi báº¡n push code lÃªn nhÃ¡nh main, pipeline sáº½ tá»± cháº¡y

# jobs:
#   build_and_push:
#     runs-on: ubuntu-latest

#     steps:
#       - name: ðŸ§¾ Checkout source code
#         uses: actions/checkout@v4

#       - name: ðŸ§ª Test backend
#         working-directory: Server
#         run: |
#           npm ci
#           npm test --if-present

#       - name: ðŸ§ª Test frontend
#         working-directory: Client/my-app
#         run: |
#           npm ci
#           npm test --if-present -- --watchAll=false

#       - name: ðŸ”‘ Login to Docker Hub
#         run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

#       - name: ðŸ—ï¸ Build & Push Backend image
#         run: |
#           docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/sgu_backend:latest ./Server
#           docker push ${{ secrets.DOCKERHUB_USERNAME }}/sgu_backend:latest

#       - name: ðŸ—ï¸ Build & Push Frontend image
#         run: |
#           docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/sgu_frontend:latest ./Client/my-app
#           docker push ${{ secrets.DOCKERHUB_USERNAME }}/sgu_frontend:latest








# name: Build & Push (after CI) // báº£n cÅ© chá»‰ cháº¡y trÃªn main

# on:
#   # Tá»± Ä‘á»™ng cháº¡y sau khi workflow "CI/CD 3-tier" káº¿t thÃºc
#   workflow_run:
#     workflows: ["CI/CD 3-tier"]   # pháº£i khá»›p 100% vá»›i tÃªn trong ci-cd.yml
#     types: [completed]

#   # Cho phÃ©p cháº¡y thá»§ cÃ´ng
#   workflow_dispatch:

# jobs:
#   build_and_push:
#     # Chá»‰ cháº¡y náº¿u CI pass hoáº·c báº¡n báº¥m tay
#     if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Login Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Build & Push Backend image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./Server
#           push: true
#           tags: ${{ secrets.DOCKERHUB_USERNAME }}/sgu_backend:latest

#       - name: Build & Push Frontend image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./Client/my-app
#           push: true
#           tags: ${{ secrets.DOCKERHUB_USERNAME }}/sgu_frontend:latest

#   deploy:
#     name: Deploy (self-hosted Windows)
#     needs: [build_and_push]
#     runs-on: self-hosted
#     if: github.ref == 'refs/heads/main'
#     defaults:
#       run:
#         shell: powershell

#     steps:
#       - uses: actions/checkout@v4

#       - name: Login Docker Hub
#         run: docker login -u $env:DOCKERHUB_USERNAME -p $env:DOCKERHUB_TOKEN
#         env:
#           DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
#           DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Check Docker versions
#         run: |
#           docker --version
#           docker compose version

#       - name: Pull images from Docker Hub
#         run: |
#           docker pull $env:DOCKERHUB_USERNAME/sgu_backend:latest
#           docker pull $env:DOCKERHUB_USERNAME/sgu_frontend:latest
#         env:
#           DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

#       - name: Validate docker-compose.yml
#         run: docker compose -f docker-compose.yml config -q

#       - name: Up services
#         run: docker compose -f docker-compose.yml up -d

#       - name: Prune old images (optional)
#         run: docker image prune -f






name: Build & Push (after CI)

on:
  # Tá»± Ä‘á»™ng cháº¡y sau khi workflow "CI/CD 3-tier" káº¿t thÃºc
  workflow_run:
    workflows: ["CI/CD 3-tier"]   # pháº£i khá»›p 100% vá»›i tÃªn trong ci-cd.yml
    types: [completed]

  # Cho phÃ©p cháº¡y thá»§ cÃ´ng
  workflow_dispatch:

jobs:
  build_and_push:
    # Chá»‰ cháº¡y náº¿u:
    # - Báº¡n tá»± báº¥m "Run workflow" (workflow_dispatch), HOáº¶C
    # - CI pass VÃ€ branch lÃ  main
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./Server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/sgu_backend:latest

      - name: Build & Push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./Client/my-app
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/sgu_frontend:latest

  deploy:
    name: Deploy (self-hosted Windows)
    needs: [build_and_push]
    runs-on: self-hosted
    # Chá»‰ deploy khi:
    # - Báº¡n tá»± báº¥m "Run workflow", HOáº¶C
    # - CI Ä‘Æ°á»£c trigger tá»« branch main
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.head_branch == 'main')
    defaults:
      run:
        shell: powershell

    steps:
      - uses: actions/checkout@v4

      - name: Login Docker Hub
        run: docker login -u $env:DOCKERHUB_USERNAME -p $env:DOCKERHUB_TOKEN
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Check Docker versions
        run: |
          docker --version
          docker compose version

      - name: Pull images from Docker Hub
        run: |
          docker pull $env:DOCKERHUB_USERNAME/sgu_backend:latest
          docker pull $env:DOCKERHUB_USERNAME/sgu_frontend:latest
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config -q

      - name: Up services
        run: docker compose -f docker-compose.yml up -d

      - name: Prune old images (optional)
        run: docker image prune -f
