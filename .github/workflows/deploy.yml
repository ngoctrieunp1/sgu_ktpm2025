# name: CI/CD for SGU_KTPM2025

# on:
#   push:
#     branches: [ main ]   # M·ªói khi b·∫°n push code l√™n nh√°nh main, pipeline s·∫Ω t·ª± ch·∫°y

# jobs:
#   build_and_push:
#     runs-on: ubuntu-latest

#     steps:
#       - name: üßæ Checkout source code
#         uses: actions/checkout@v4

#       - name: üß™ Test backend
#         working-directory: Server
#         run: |
#           npm ci
#           npm test --if-present

#       - name: üß™ Test frontend
#         working-directory: Client/my-app
#         run: |
#           npm ci
#           npm test --if-present -- --watchAll=false

#       - name: üîë Login to Docker Hub
#         run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

#       - name: üèóÔ∏è Build & Push Backend image
#         run: |
#           docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/sgu_backend:latest ./Server
#           docker push ${{ secrets.DOCKERHUB_USERNAME }}/sgu_backend:latest

#       - name: üèóÔ∏è Build & Push Frontend image
#         run: |
#           docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/sgu_frontend:latest ./Client/my-app
#           docker push ${{ secrets.DOCKERHUB_USERNAME }}/sgu_frontend:latest


name: Build & Push (after CI)

on:
  # T·ª± ƒë·ªông ch·∫°y sau khi workflow "CI/CD 3-tier" k·∫øt th√∫c
  workflow_run:
    workflows: ["CI/CD 3-tier"]   # ph·∫£i kh·ªõp 100% v·ªõi t√™n trong ci-cd.yml
    types: [completed]

  # Cho ph√©p ch·∫°y th·ªß c√¥ng
  workflow_dispatch:

jobs:
  build_and_push:
    # Ch·ªâ ch·∫°y n·∫øu CI pass ho·∫∑c b·∫°n b·∫•m tay
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./Server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/sgu_backend:latest

      - name: Build & Push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./Client/my-app
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/sgu_frontend:latest

  deploy:
    name: Deploy (self-hosted Windows)
    needs: [build_and_push]
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        shell: powershell

    steps:
      - uses: actions/checkout@v4

      - name: Login Docker Hub
        run: docker login -u $env:DOCKERHUB_USERNAME -p $env:DOCKERHUB_TOKEN
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Check Docker versions
        run: |
          docker --version
          docker compose version

      - name: Pull images from Docker Hub
        run: |
          docker pull $env:DOCKERHUB_USERNAME/sgu_backend:latest
          docker pull $env:DOCKERHUB_USERNAME/sgu_frontend:latest
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config -q

      - name: Up services
        run: docker compose -f docker-compose.yml up -d

      - name: Prune old images (optional)
        run: docker image prune -f
